---
author: JinnyYi <github.com/JinnyYi>
status: draft
updated_at: 2021-06-09
---

# GSP-97: Add Maximum File Size for Storage Write

## Background

Depending on the size of the data you are uploading, services offer different options, like upload a file in a single operation, in parts, or through append operation.

We use `Write` to handle single write operation. And the size is not unlimited.

- S3 alike storage services have 5GB limit for a single PUT operation.
- azblob limited to 5000 MiB(<https://docs.microsoft.com/en-us/rest/api/storageservices/put-blob>).

If we upload a file with size out of limit in a single operation, we will get an error like `Request Entity Too Large` in azblob. Same with `copy`,`fetch`, etc.

We should figure out the error before sending request to reduce the consumption of network resources.

These restrictions belong to service. We have `StorageMeta` to carry storage related information:

```go
type StorageMeta struct {
	location string
	Name     string
	WorkDir  string
	
	// bit used as a bitmap for object value, 0 means not set, 1 means set 
	bit uint64
	m   map[string]interface{}
}
```

But the current `StorageMeta` cannot solve the above problem:

- The fields are finite. For now, `m` is unused, and it's not convenient to hold the extra unknown metadata.
- If we want to use storage metadata internally we have to call `metadata` repeatedly.

## Proposal

So I propose to add maximum size restriction as service related metadata for storage operations.

We will add `service-metadata` with type `any` into [info_storage_meta.toml].

```toml
[service-metadata]
type = "any"
description = "serviceMetadata stores service related metadata"
```

So that `serviceMetadata` with type `interface{}` will be generated and added into `StorageMeta` to hold the restrictions and possible settings in the future.

```go
type StorageMeta struct {
	location        string
	Name            string
	WorkDir         string
	serviceMetadata interface{}
	
	// bit used as a bitmap for object value, 0 means not set, 1 means set 
	bit uint64
}
```

To assign `serviceMetadata`, [go-storage] should generate the `StorageMetadata` structure through the field `[infos.storage.meta.<storage meta name>]` like the `ObjectMetadata`. `set/get` functions are the same.

```toml
[infos.storage.meta.<storage meta name>]
type = "<type>"
description = "<description>"
```

Take add maximum file size for storage write operation as an example.

We should add the following in `service.toml`:

```toml
[infos.storage.meta.maxinum-write-size]
type = "int64"
description = "Maximun data size for single write operation."
```

Then `StorageMetadata` should be generated by go generate via cmd/definitions:

```go
type StorageMetadata struct {
	// MaximumWriteSize
	MaximumWriteSize int64
}

func setServiceMetadata(s *StorageMeta, sm StorageMetadata) {
    s.SetServiceMetadata(sm)
}

func GetStorageMetadata(s *StorageMeta) StorageMetadata {
    sm, ok := s.GetStorageMetadata()
    if ok {
        return sm.(StorageMetadata)
    }
    return StorageMetadata{}
}
```

For services, we will add a member with type `StorageMeta` and remove the separate field in `Storage`.

```go
type Storage struct {
	sm           StorageMeta
	
	defaultPairs DefaultStoragePairs
	features     StorageFeatures
	
	typ.UnimplementedStorager
	...
}
```

Metadata for the storager will be set at the time it is initiated. After that we can use the metadata in storage operations if necessary.

## Rationale

### Alternative Way: Ignore size limit

The alternative way is to send request directly without size check and get an error when the `size` larger than the limit.

This will need invalid request and get the ambiguous error.

## Compatibility

This change will break all services.

## Implementation

- `specs` should add `service-metadata` with type `any` in storage meta toml.
- `go-storage`
  - Generate `serviceMetada` and corresponding `get/set` functions into `StorageMeta`.
  - Support generate `StorageMetadata` distinguish with `ObjectMetadata` by `Infos.Scope`.
- `go-service-*`
   - Add a member with type `StorageMeta` in `Storage` and assign it on initialization.
   - Check `size` for write related operations and return `ErrRestrictionDissatisfied` when `size` out of limit.

[info_storage_meta.toml]: ../definitions/info_storage_meta.toml
[go-storage]: https://github.com/beyondstorage/go-storage
